<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>オンライン審査投票</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
    }

    .container {
      max-width: 900px;
      margin: 32px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      padding: 24px 28px 32px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1.5rem;
    }

    .info-box {
      background: #f0f4ff;
      border-left: 4px solid #325dff;
      padding: 10px 12px;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      border-radius: 6px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    select, input[type="number"], input[type="text"] {
      width: 100%;
      max-width: 320px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .field {
      margin-bottom: 16px;
    }

    .scores-section {
      margin-top: 20px;
      padding-top: 12px;
      border-top: 1px dashed #ddd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    th, td {
      padding: 8px;
      text-align: left;
      font-size: 0.95rem;
    }

    th {
      background-color: #f7f7f7;
      border-bottom: 1px solid #ddd;
    }

    tr:nth-child(even) td {
      background-color: #fafafa;
    }

    .score-input {
      width: 60px;
    }

    .comment-input {
      width: 100%;
      max-width: none;
    }

    .btn-row {
      margin-top: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    button {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
      background: #325dff;
      color: white;
      font-weight: 600;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .secondary-btn {
      background: #e5e7eb;
      color: #333;
    }

    .status {
      font-size: 0.85rem;
      color: #555;
      margin-top: 8px;
    }

    .status.error {
      color: #c53030;
    }
    .status.success {
      color: #047857;
    }

    .result-box {
      margin-top: 24px;
      font-size: 0.9rem;
    }

    .result-box textarea {
      width: 100%;
      min-height: 120px;
      font-family: "JetBrains Mono", "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 8px;
      box-sizing: border-box;
      background: #fbfbfb;
    }

    .small {
      font-size: 0.8rem;
      color: #777;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>オンライン審査投票</h1>
  <div class="subtitle">
    各審査委員は、自分に割り当てられた3名の参加者（P1–P35）について0〜5点を入力し、結果を提出してください。
  </div>

  <div class="info-box">
    • 審査委員IDを選択すると、その審査委員に割り当てられた3名の参加者が自動的に表示されます。<br>
    • 各参加者について<b>0〜5点</b>を入力し、<b>「結果送信」</b>ボタンを押してください。<br>
    • 下部に生成された結果（JSON/CSV）をコピーし、管理者から案内されたメール・スプレッドシート等に貼り付けて送信すると集計が可能です。
  </div>

  <form id="vote-form" onsubmit="return false;">
    <div class="field">
      <label for="judge-id">審査委員ID</label>
      <select id="judge-id" required>
        <option value="">-- 審査委員を選択してください --</option>
        <option value="J1">J1</option>
        <option value="J2">J2</option>
        <option value="J3">J3</option>
        <option value="J4">J4</option>
        <option value="J5">J5</option>
        <option value="J6">J6</option>
        <option value="J7">J7</option>
        <option value="J8">J8</option>
        <option value="J9">J9</option>
        <option value="J10">J10</option>
        <option value="J11">J11</option>
        <option value="J12">J12</option>
        <option value="J13">J13</option>
        <option value="J14">J14</option>
        <option value="J15">J15</option>
        <option value="J16">J16</option>
      </select>
    </div>

    <div class="field">
      <label for="judge-name">審査委員名（任意）</label>
      <input type="text" id="judge-name" placeholder="例：山田太郎">
    </div>

    <div id="scores-section" class="scores-section" style="display:none;">
      <h3>割り当てられた参加者の点数入力</h3>
      <table>
        <thead>
        <tr>
          <th style="width: 15%;">参加者ID</th>
          <th style="width: 15%;">点数（0–5）</th>
          <th>コメント（任意）</th>
        </tr>
        </thead>
        <tbody id="score-rows">
        <!-- 자바스크립트로 동적 생성 -->
        </tbody>
      </table>
      <div class="small">
        ※ 点数は整数の0〜5のみ入力できます。（例：0, 1, 2, 3, 4, 5）
      </div>
    </div>

    <div class="btn-row">
      <button type="button" id="submit-btn" disabled>結果送信</button>
      <button type="reset" class="secondary-btn" id="reset-btn">リセット</button>
      <span id="status" class="status"></span>
    </div>
  </form>

  <div class="result-box" id="result-box" style="display:none;">
    <h3>生成された結果（JSON）</h3>
    <textarea id="json-output" readonly></textarea>
    <div class="small" style="margin-top:4px;">
      → このJSONテキストをコピーして、管理者が指定したメールまたは集計用システムに貼り付けてください。
    </div>

    <h3 style="margin-top:16px;">簡易CSV（1行）</h3>
    <textarea id="csv-output" readonly></textarea>
    <div class="small" style="margin-top:4px;">
      → スプレッドシート（Excel, Google Sheets など）に貼り付けやすい形式です。
    </div>
  </div>
</div>

<script>
  // ================================
  // 1) 審査委員ごとの割り当て情報の設定
  // ================================
  // TODO: 実際の割り当てに合わせて、この部分だけを書き換えて使用してください。
  // 各審査委員（J1〜J16など）ごとに、評価対象となる参加者ID（P1〜P35）を3件ずつ指定します。
  const assignments = {
    J1: ["P1", "P2", "P3"],
    J2: ["P4", "P5", "P6"],
    J3: ["P7", "P8", "P9"],
    J4: ["P10", "P11", "P12"],
    J5: ["P13", "P14", "P15"],
    J6: ["P16", "P17", "P18"],
    J7: ["P19", "P20", "P21"],
    J8: ["P22", "P23", "P24"],
    J9: ["P25", "P26", "P27"],
    J10: ["P28", "P29", "P30"],
    J11: ["P31", "P32", "P33"],
    J12: ["P34", "P35", "P1"],  // 例：必要に応じて自由に変更してください。
    J13: ["P2", "P3", "P4"],
    J14: ["P5", "P6", "P7"],
    J15: ["P8", "P9", "P10"],
    J16: ["P11", "P12", "P13"]
  };

  const judgeSelect = document.getElementById('judge-id');
  const scoresSection = document.getElementById('scores-section');
  const scoreRows = document.getElementById('score-rows');
  const submitBtn = document.getElementById('submit-btn');
  const resetBtn = document.getElementById('reset-btn');
  const statusSpan = document.getElementById('status');
  const resultBox = document.getElementById('result-box');
  const jsonOutput = document.getElementById('json-output');
  const csvOutput = document.getElementById('csv-output');
  const judgeNameInput = document.getElementById('judge-name');

  // 審査委員が変更されたときに、その審査委員に割り当てられた参加者一覧を表示
  judgeSelect.addEventListener('change', () => {
    const judgeId = judgeSelect.value;
    statusSpan.textContent = '';
    statusSpan.className = 'status';
    resultBox.style.display = 'none';
    jsonOutput.value = '';
    csvOutput.value = '';

    // 未選択の場合
    if (!judgeId) {
      scoresSection.style.display = 'none';
      scoreRows.innerHTML = '';
      submitBtn.disabled = true;
      return;
    }

    const assigned = assignments[judgeId];
    if (!assigned || assigned.length === 0) {
      scoresSection.style.display = 'none';
      scoreRows.innerHTML = '';
      submitBtn.disabled = true;
      statusSpan.textContent = 'この審査委員に割り当てられた参加者が設定されていません。（assignments の設定を確認してください）';
      statusSpan.classList.add('error');
      return;
    }

    // テーブル行の生成
    scoreRows.innerHTML = '';
    assigned.forEach((pid, idx) => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td');
      tdId.textContent = pid;
      tr.appendChild(tdId);

      const tdScore = document.createElement('td');
      const inputScore = document.createElement('input');
      inputScore.type = 'number';
      inputScore.min = '0';
      inputScore.max = '5';
      inputScore.step = '1';
      inputScore.required = true;
      inputScore.className = 'score-input';
      inputScore.name = `score_${pid}`;
      inputScore.placeholder = '0–5';
      tdScore.appendChild(inputScore);
      tr.appendChild(tdScore);

      const tdComment = document.createElement('td');
      const inputComment = document.createElement('input');
      inputComment.type = 'text';
      inputComment.className = 'comment-input';
      inputComment.name = `comment_${pid}`;
      inputComment.placeholder = '必要に応じてコメントを入力（任意）';
      tdComment.appendChild(inputComment);
      tr.appendChild(tdComment);

      scoreRows.appendChild(tr);
    });

    scoresSection.style.display = 'block';
    submitBtn.disabled = false;
  });

  // リセットボタン
  resetBtn.addEventListener('click', () => {
    judgeSelect.value = '';
    judgeNameInput.value = '';
    scoresSection.style.display = 'none';
    scoreRows.innerHTML = '';
    submitBtn.disabled = true;
    statusSpan.textContent = '';
    statusSpan.className = 'status';
    resultBox.style.display = 'none';
    jsonOutput.value = '';
    csvOutput.value = '';
  });

  // バリデーション関数（0〜5の整数かどうかを確認）
  function validateScore(value) {
    if (value === '' || value === null || value === undefined) return false;
    const n = Number(value);
    if (!Number.isInteger(n)) return false;
    return n >= 0 && n <= 5;
  }

  // 「結果送信」ボタン
  submitBtn.addEventListener('click', () => {
    const judgeId = judgeSelect.value;
    if (!judgeId) {
      statusSpan.textContent = '先に審査委員IDを選択してください。';
      statusSpan.className = 'status error';
      return;
    }

    const assigned = assignments[judgeId];
    if (!assigned || assigned.length === 0) {
      statusSpan.textContent = '割り当て情報がありません。（assignments の設定を確認してください）';
      statusSpan.className = 'status error';
      return;
    }

    // 点数・コメントの収集
    const entries = [];
    let hasError = false;
    assigned.forEach(pid => {
      const scoreInput = document.querySelector(`input[name="score_${pid}"]`);
      const commentInput = document.querySelector(`input[name="comment_${pid}"]`);
      const rawScore = scoreInput ? scoreInput.value.trim() : '';

      if (!validateScore(rawScore)) {
        hasError = true;
        scoreInput.style.borderColor = '#c53030';
      } else {
        scoreInput.style.borderColor = '#ccc';
      }

      entries.push({
        participantId: pid,
        score: rawScore === '' ? null : Number(rawScore),
        comment: commentInput ? commentInput.value.trim() : ''
      });
    });

    if (hasError) {
      statusSpan.textContent = 'すべての参加者について0〜5の整数の点数を入力してください。';
      statusSpan.className = 'status error';
      resultBox.style.display = 'none';
      return;
    }

    // 結果オブジェクトの生成
    const payload = {
      judgeId: judgeId,
      judgeName: judgeNameInput.value.trim() || null,
      timestamp: new Date().toISOString(),
      results: entries
    };

    const jsonStr = JSON.stringify(payload, null, 2);
    jsonOutput.value = jsonStr;

    // CSVの生成（元のコードをそのまま使用）
    const csvParts = [];
    function csvEscape(str) {
      if (str === null || str === undefined) return '';
      const s = String(str);
      if (s.includes('"') || s.includes(',') || s.includes('\n')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }
    csvParts.push(csvEscape(judgeId));
    csvParts.push(csvEscape(judgeNameInput.value.trim() || ''));
    entries.forEach(e => {
      csvParts.push(csvEscape(e.participantId));
      csvParts.push(csvEscape(e.score));
      csvParts.push(csvEscape(e.comment));
    });
    csvOutput.value = csvParts.join(',');

    resultBox.style.display = 'block';

    // ---- ここからバックエンドへ送信 ----
    statusSpan.textContent = 'サーバーへ送信中です…';
    statusSpan.className = 'status';

    fetch('https://vote-nit6.onrender.com', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(async (res) => {
      if (!res.ok) {
        const text = await res.text();
        throw new Error('HTTP ' + res.status + ' ' + text);
      }
      return res.json();
    })
    .then(data => {
      statusSpan.textContent = 'Dropboxへのアップロード完了：' + (data.path || '');
      statusSpan.className = 'status success';
    })
    .catch(err => {
      console.error(err);
      statusSpan.textContent = 'サーバー送信／Dropboxアップロード中にエラーが発生しました。（管理者にお問い合わせください）';
      statusSpan.className = 'status error';
    });
  });
</script>
</body>
</html>
